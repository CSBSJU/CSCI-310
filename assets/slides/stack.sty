\RequirePackage{ifthen}
\RequirePackage{tikz}
\usetikzlibrary{arrows,patterns,circuits.ee.IEC}

% define counter to track which stack within a tikzstack environment
\newcounter{stack}

% define the tikzstack environment
\newenvironment{tikzstack}[1][bg]{%
  \setcounter{stack}{0}%
  \begin{tikzpicture}[
    x=1em,
    y=1em,
    font=\ttfamily,
    base/.style={
      anchor=north west,
    },
  ]%
    \newenvironment{stack}[2][]{%
      \stepcounter{stack}%
      \ifthenelse{\equal{##2}{east}}
        {
          \def\displs{-1em}
          \def\polar{west}
          \def\angle{180}
        }
        {
          \def\displs{1em}
          \def\polar{east}
          \def\angle{0}
        }%
      \begin{scope}[
        circuit ee IEC,
        dot/.style={
          circle,
          inner sep=0pt,
          minimum size=3pt,
          fill,
        },
        var/.style={
          draw,
          rectangle,
          anchor=south west,
          minimum width=3.0em,
          minimum height=1.5em,
          label={##2:####1},
        },
        ptr/.style={
          ->,
          >=stealth',
          semithick,
          rounded corners,
        },
        null/.style={
          ground,
          scale=0.5,
          anchor=west,
          rotate=\angle,
        },
        ##1
      ]%
        \newcommand{\variables}[1]{%
          \foreach [
            count=\i,
            evaluate=\i as \y using (1.5*(\i-1)),
          ] \l/\v in {####1}
          {
            \node[var=\l] at (0.0,\y) (var\thestack-\i) {\v};
          }%
        }%
        \newcommand{\pointers}[1]{%
          \foreach \s/\e in {####1}
          {
            \draw[ptr]
              (var\thestack-\s.center) node[dot] {} --
              ([xshift=\displs]var\thestack-\s.\polar) --
              ([xshift=-\displs]var\e.##2) --
              (var\e.##2);
          }%
        }%
        % FIXME define a command pointers* instead of a separate command
        \newcommand{\ipointers}[1]{%
          \foreach \s/\e/\d in {####1}
          {
            \draw[ptr]
              (var\thestack-\s.center) node[dot] {} --
              ([xshift=\d]var\thestack-\s.\polar) --
              ([xshift=\d]var\thestack-\e.\polar) --
              (var\thestack-\e.\polar);
          }%
        }%
        \newcommand{\nulls}[1]{%
          \foreach \s in {####1}
          {
            \draw[fill]
              (var\thestack-\s.center) node[dot] {} --
              ([xshift=\displs]var\thestack-\s.\polar) node[null] {};
          }%
        }%
        \newcommand{\frames}[1]{%
          \foreach [
            evaluate=\s as \y using (1.5*\s),
            evaluate=\e as \h using (1.5*\e),
          ] \s/\e in {####1}
          {
            \draw[ultra thick] (0.0,\y) rectangle ++(3.0,\h);
          }%
        }%
    }{%
      \end{scope}%
    }
    \draw[color=#1] (-0.5,0.0) -- (3.5,0.0) node[base] {};%
    \fill[pattern=north east lines,pattern color=#1] (-0.5,-0.5) rectangle ++(4.0,0.5) node[base] {};%
}{%
  \end{tikzpicture}%
}

